<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Preventive Maintenance Checklist</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-darkest': '#181A2F',
                        'primary-dark': '#242E49',
                        'primary-medium': '#37415C',
                        'accent-peach': '#FDA481',
                        'accent-red': '#B4182D',
                        'accent-maroon': '#54162B',
                    }
                }
            }
        }
    </script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #242E49; }
        ::-webkit-scrollbar-thumb { background: #37415C; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #4a5570; }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid #FDA481;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-primary-darkest text-gray-300">

    <div id="login-view" class="flex items-center justify-center min-h-screen">
        <div class="w-full max-w-md p-8 space-y-8 bg-primary-dark rounded-2xl shadow-2xl shadow-primary-darkest/50">
            <div class="text-center">
                <h2 class="text-3xl font-bold text-white">Welcome Back</h2>
                <p class="mt-2 text-gray-400">Sign in to access the Maintenance Checklist</p>
            </div>
            <form id="login-form" class="mt-8 space-y-6">
                <div class="rounded-md shadow-sm -space-y-px">
                    <input id="username" name="username" type="text" required class="appearance-none rounded-none relative block w-full px-3 py-3 border border-gray-600 bg-primary-medium text-white placeholder-gray-400 rounded-t-md focus:outline-none focus:ring-accent-peach focus:border-accent-peach sm:text-sm transition" placeholder="User">
                    <input id="password" name="password" type="password" required class="appearance-none rounded-none relative block w-full px-3 py-3 border border-gray-600 bg-primary-medium text-white placeholder-gray-400 rounded-b-md focus:outline-none focus:ring-accent-peach focus:border-accent-peach sm:text-sm transition" placeholder="Password">
                </div>
                <button type="submit" class="group relative w-full flex justify-center py-3 px-4 border border-transparent text-sm font-bold rounded-md text-primary-darkest bg-accent-peach hover:bg-opacity-90 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-primary-dark focus:ring-accent-peach transition">
                    Log In
                </button>
                 <p id="error-message" class="text-sm text-center text-accent-red h-4"></p>
            </form>
        </div>
    </div>

    <div id="checklist-view" class="hidden">
        <div class="container mx-auto p-4 sm:p-6 lg:p-8">
            <div class="bg-primary-dark rounded-2xl shadow-2xl shadow-primary-darkest/50 p-6 sm:p-8">
                <header class="mb-8 flex justify-between items-center">
                    <div>
                         <h1 class="text-2xl sm:text-3xl font-bold text-white">Preventive Maintenance Checklist</h1>
                         <p class="text-gray-400 mt-1">Logged in as: <span id="loggedInUserDisplay" class="font-bold text-accent-peach"></span></p>
                    </div>
                    <button id="logoutButton" class="px-4 py-2 bg-accent-red text-white font-medium text-sm rounded-lg hover:bg-opacity-90 focus:outline-none focus:ring-4 focus:ring-accent-red/50 transition duration-300">
                        Log Out
                    </button>
                </header>

                <div class="mb-8 border-b border-gray-700 pb-8">
                    <h2 class="text-xl font-bold text-white mb-4">Customer & Machine Details</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <input type="text" id="customerName" placeholder="Customer Name" class="w-full bg-primary-medium border border-gray-600 text-white rounded-lg p-2.5 text-sm focus:ring-2 focus:ring-accent-peach focus:border-accent-peach transition">
                        <input type="text" id="country" placeholder="Country" class="w-full bg-primary-medium border border-gray-600 text-white rounded-lg p-2.5 text-sm focus:ring-2 focus:ring-accent-peach focus:border-accent-peach transition">
                        <input type="text" id="machineType" placeholder="Machine Type" class="w-full bg-primary-medium border border-gray-600 text-white rounded-lg p-2.5 text-sm focus:ring-2 focus:ring-accent-peach focus:border-accent-peach transition">
                        <input type="text" id="serialNo" placeholder="Serial No." class="w-full bg-primary-medium border border-gray-600 text-white rounded-lg p-2.5 text-sm focus:ring-2 focus:ring-accent-peach focus:border-accent-peach transition">
                        <div>
                             <label for="inspectedDate" class="block text-sm font-medium text-gray-400 mb-1">Inspected Date</label>
                             <input type="date" id="inspectedDate" class="w-full bg-primary-medium border border-gray-600 text-white rounded-lg p-2.5 text-sm focus:ring-2 focus:ring-accent-peach focus:border-accent-peach transition">
                        </div>
                    </div>
                </div>
                
                <div class="overflow-x-auto rounded-lg border border-gray-700">
                    <table class="w-full text-sm text-left" id="checklistTable">
                        <thead class="bg-primary-medium text-xs text-accent-peach uppercase">
                            <tr>
                                <th class="px-6 py-4 font-semibold tracking-wider">Inspection List</th>
                                <th class="px-6 py-4 text-center font-semibold tracking-wider" colspan="5">Required Action</th>
                                <th class="px-6 py-4 font-semibold tracking-wider">Result</th>
                            </tr>
                            <tr class="bg-primary-dark/50 border-b border-gray-700">
                                <td></td>
                                <td class="w-12 text-center py-2 font-bold" title="Normal">N</td>
                                <td class="w-12 text-center py-2 font-bold" title="Adjust">A</td>
                                <td class="w-12 text-center py-2 font-bold" title="Clean">C</td>
                                <td class="w-12 text-center py-2 font-bold" title="Replace">R</td>
                                <td class="w-12 text-center py-2 font-bold" title="Improve">I</td>
                                <td></td>
                            </tr>
                        </thead>
                        <tbody id="checklist-body" class="text-gray-300"></tbody>
                    </table>
                </div>

                <div class="mt-8 flex justify-end items-center gap-4">
                    <button id="submitButton" class="flex items-center justify-center gap-2 w-full sm:w-auto px-6 py-2.5 bg-accent-peach text-primary-darkest font-bold text-sm rounded-lg hover:bg-opacity-90 focus:outline-none focus:ring-4 focus:ring-accent-peach/50 transition duration-300 disabled:opacity-50 disabled:cursor-wait">
                        <span id="submitButtonText">Create Customer & Submit</span>
                        <div id="submitSpinner" class="spinner hidden"></div>
                    </button>
                </div>
            </div>
        </div>

        <div id="submissionModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50 p-4">
            <div class="bg-primary-dark rounded-lg shadow-2xl w-full max-w-md flex flex-col border border-gray-700 text-center p-8">
                 <div id="modal-content"></div>
                 <button id="closeModal" class="mt-6 px-4 py-2 bg-accent-red text-white font-medium text-sm rounded-lg hover:bg-opacity-90 focus:outline-none focus:ring-4 focus:ring-accent-red/50 transition duration-300">Close</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            let loggedInTechnician = null;

            // --- DOM Elements ---
            const loginView = document.getElementById('login-view');
            const checklistView = document.getElementById('checklist-view');
            const loginForm = document.getElementById('login-form');
            const logoutButton = document.getElementById('logoutButton');
            const errorMessage = document.getElementById('error-message');
            
            // --- Login/Logout Logic ---
            loginForm.addEventListener('submit', async function(event) {
                event.preventDefault();
                const loginButton = loginForm.querySelector('button[type="submit"]');
                loginButton.disabled = true;
                errorMessage.textContent = 'Checking...';
                
                try {
                    const response = await fetch('/api/login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username: loginForm.username.value, password: loginForm.password.value })
                    });
                    const result = await response.json();
                    if (response.ok && result.status === 'success') {
                        loggedInTechnician = result.username;
                        document.getElementById('loggedInUserDisplay').textContent = loggedInTechnician;
                        loginView.classList.add('hidden');
                        checklistView.classList.remove('hidden');
                        errorMessage.textContent = '';
                        loginForm.password.value = '';
                    } else {
                        throw new Error(result.message || 'Invalid user or password.');
                    }
                } catch (error) {
                    errorMessage.textContent = error.message;
                } finally {
                    loginButton.disabled = false;
                }
            });

            logoutButton.addEventListener('click', () => {
                loggedInTechnician = null;
                checklistView.classList.add('hidden');
                loginView.classList.remove('hidden');
                // Reset form fields on logout
                document.getElementById('customerName').value = '';
                document.getElementById('country').value = '';
                document.getElementById('machineType').value = '';
                document.getElementById('serialNo').value = '';
                renderChecklist();
            });

            // --- Checklist Data and Rendering ---
            const checklistData = [
                { category: 'Pump & Mechanical', items: [
                    { text: 'Check the gear pump motor.', id: 'Motor_Check' },
                    { text: 'Check the oil level of the motor gear.', id: 'Motor_Gear_Oil' },
                    { text: 'Check the motor gear.', id: 'Motor_Gear_Condition' },
                    { text: 'Check the packing seal at the gear pump.', id: 'Pump_Seal' },
                    { text: 'Check for material leakage.', id: 'Material_Leakage' },
                    { text: 'Check the joint between the pump and drive shaft.', id: 'Shaft_Joint' },
                    { text: 'Check the gear pump rotation.', id: 'Pump_Rotation' },
                    { text: 'Check the motor gear mounting.', id: 'Motor_Mounting' },
                    { text: 'Check the filter screen retainer.', id: 'Filter_Retainer' },
                    { text: 'Check gear pump cleaning/cleanliness.', id: 'Pump_Cleanliness' },
                    { text: 'Check the safety pin on the shaft joint.', id: 'Shaft_Safety_Pin' }
                ]},
                { category: 'Heating System', items: [
                    { text: 'Check the condition of the heater.', id: 'Heater_Condition' },
                    { text: 'Check the thermocouple.', id: 'Thermocouple_Check' },
                    { text: 'Check the temperature controller.', id: 'Temp_Controller' },
                    { text: 'Check the insulation for heater cables.', id: 'Heater_Cable_Insulation' },
                    { text: 'Check the heater cable and connection.', id: 'Heater_Cable_Connection' }
                ]},
                { category: 'Electrical & Controls', items: [
                    { text: 'Check the inverter of the gear pump motor.', id: 'Motor_Inverter' },
                    { text: 'Check the closed-loop control for pressure.', id: 'Pressure_Control_Loop' },
                    { text: 'Check the motor overload circuit breaker.', id: 'Motor_Overload_Breaker' },
                    { text: 'Check the pressure transducer.', id: 'Pressure_Transducer' },
                    { text: 'Check the indicator lamps.', id: 'Indicator_Lamps' },
                    { text: 'Check all switches.', id: 'Switches_Check' },
                    { text: 'Check the condition of the PC.', id: 'PC_Condition' }
                ]},
                { category: 'Alarms & Safety', items: [
                    { text: 'Check the low-temperature alarm.', id: 'Low_Temp_Alarm' },
                    { text: 'Check the high/low-pressure alarm.', id: 'Pressure_Alarms' },
                    { text: 'Check the buzzer.', id: 'Buzzer_Check' },
                    { text: 'Check the emergency stop button.', id: 'Emergency_Stop' }
                ]}
            ];

            const checklistBody = document.getElementById('checklist-body');
            function renderChecklist() {
                checklistBody.innerHTML = '';
                let rowIndex = 0;
                checklistData.forEach(section => {
                    checklistBody.innerHTML += `<tr class="bg-primary-medium/40"><td colspan="8" class="px-6 py-3 font-bold text-white">${section.category}</td></tr>`;
                    section.items.forEach(item => {
                        const actionName = `action-row-${rowIndex}`;
                        checklistBody.innerHTML += `
                            <tr class="border-b border-gray-700 hover:bg-primary-medium/50 transition duration-150" data-item-id="${item.id}">
                                <td class="px-6 py-4">${item.text}</td>
                                ${['N', 'A', 'C', 'R', 'I'].map(action => `
                                    <td class="text-center py-4">
                                        <input type="radio" id="${actionName}-${action}" name="${actionName}" value="${action}" class="w-4 h-4 text-accent-peach bg-gray-700 border-gray-600 focus:ring-accent-peach">
                                    </td>
                                `).join('')}
                                <td class="px-6 py-4">
                                    <input type="text" class="result-input w-full bg-primary-medium border border-gray-600 text-white rounded-md p-2 text-sm focus:ring-1 focus:ring-accent-peach focus:border-accent-peach" placeholder="Result...">
                                </td>
                            </tr>
                        `;
                        rowIndex++;
                    });
                });
            }

            // --- Data Submission Logic ---
            const submissionModal = document.getElementById('submissionModal');
            const modalContent = document.getElementById('modal-content');
            const submitButton = document.getElementById('submitButton');
            const submitButtonText = document.getElementById('submitButtonText');
            const submitSpinner = document.getElementById('submitSpinner');
            
            submitButton.addEventListener('click', async () => {
                submitButton.disabled = true;
                submitButtonText.textContent = 'Submitting...';
                submitSpinner.classList.remove('hidden');
                
                try {
                    // Step 1: Create Customer
                    const customerData = {
                        CustomerName: document.getElementById('customerName').value,
                        Country: document.getElementById('country').value,
                        MachineType: document.getElementById('machineType').value,
                        SerialNo: document.getElementById('serialNo').value,
                    };

                    const customerResponse = await fetch('/api/createCustomer', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(customerData),
                    });
                    const customerResult = await customerResponse.json();
                    if (!customerResponse.ok) throw new Error(customerResult.message || 'Failed to create customer.');

                    const newCustomerID = customerResult.customerID;

                    // Step 2: Collect Checklist Data
                    const checklistResultData = {
                        CustomerID: newCustomerID,
                        Technician: loggedInTechnician,
                        TechnicianID: loggedInTechnician,
                        InspectedDate: document.getElementById('inspectedDate').value,
                    };
                    document.querySelectorAll('#checklistTable tbody tr[data-item-id]').forEach(row => {
                        const itemId = row.dataset.itemId;
                        const selectedAction = row.querySelector(`input[type="radio"]:checked`);
                        const resultText = row.querySelector('.result-input').value;
                        checklistResultData[itemId] = selectedAction ? `${selectedAction.value} - ${resultText}` : resultText;
                    });
                    
                    // Step 3: Submit Checklist
                    const checklistResponse = await fetch('/api/submitChecklist', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(checklistResultData),
                    });
                     const checklistSubmitResult = await checklistResponse.json();
                    if (!checklistResponse.ok) throw new Error(checklistSubmitResult.message || 'Submission failed.');
                    
                    modalContent.innerHTML = `<h3 class="text-xl font-bold text-green-400 mb-4">Success!</h3><p class="text-gray-300">Customer and checklist have been recorded successfully. New Customer ID: ${newCustomerID}</p>`;
                
                } catch (error) {
                    modalContent.innerHTML = `<h3 class="text-xl font-bold text-red-500 mb-4">Error</h3><p class="text-gray-300">${error.message}</p>`;
                } finally {
                    submissionModal.classList.remove('hidden');
                    submitButton.disabled = false;
                    submitButtonText.textContent = 'Create Customer & Submit';
                    submitSpinner.classList.add('hidden');
                }
            });
            
            document.getElementById('closeModal').addEventListener('click', () => submissionModal.classList.add('hidden'));

            // --- Initialisation ---
            renderChecklist();
            document.getElementById('inspectedDate').valueAsDate = new Date();
        });
    </script>
</body>
</html>